# Ralph Progress Log
Started: Fri Feb 27 11:46:39 -03 2026

## Codebase Patterns
- Use `bcrypt.hashpw(password.encode("utf-8"), bcrypt.gensalt()).decode("utf-8")` for password hashing
- Admin section uses sub-navigation (ViewTab) in App.tsx with `adminSubView` state for Sellers vs Usuários
- UsersPage receives `headers` and `currentUserId` props from App.tsx (not from useAuth directly)
- Use `bcrypt.checkpw(password.encode(), hashed.encode())` for password verification
- Supabase client: `db.table("name").select/insert/update/delete` pattern via `get_db()` from `app.db.supabase`
- FastAPI dependencies that return user dicts are passed via `Depends()` — use `user: dict = Depends(require_user)`
- Auth header is `X-Auth-Token` extracted via `Header(...)` in FastAPI
- Session tokens are `secrets.token_urlsafe(32)` with 7-day expiry stored in `user_sessions`
- All migrations use `IF NOT EXISTS` pattern
- Python modules compile-checked with `python3 -m py_compile`
- Frontend typecheck: `cd frontend && npx tsc --noEmit`
- `require_admin` from `app.routers.auth` is imported by `auth_ml.py`, `copy.py`, `compat.py`, `admin_users.py`
- Admin user CRUD router: `app/routers/admin_users.py` with prefix `/api/admin`
- USER_FIELDS constant for safe select (excludes password_hash): `"id, username, role, can_run_compat, active, created_at, last_login_at"`
- Supabase upsert with composite key: `.upsert(data, on_conflict="col1,col2")`
- `copy_sellers` table has `slug` and `name` columns for seller identification
- Permission check pattern: `_check_seller_permission(user, seller_slug, "from"|"to")` helper in copy.py
- Admin bypass: always check `user["role"] == "admin"` before permission checks
- `search_sku_all_sellers` accepts optional `allowed_sellers` param to filter sellers
- Supabase join for username: `.select("*, users(username)")` then flatten `row.pop("users")["username"]`
- Audit logging: wrap `auth_logs` inserts in try/except so logging failures don't break main operations
- Log entry pattern: conditionally add `user_id` only if present (`if user_id: log_entry["user_id"] = user_id`)
- Frontend auth token: localStorage key is `copy-auth-token`, header is `X-Auth-Token`
- `useAuth.login` signature: `(username: string, password: string) => Promise<boolean>`
- `useAuth` exports `user: AuthUser | null` with `{id, username, role, can_run_compat, permissions}`
- `AuthUser` and `UserPermission` types exported from `hooks/useAuth.ts`
- `isAuthenticated` requires both token AND user object (double check)
- Tab visibility: check `user.permissions.some(p => p.can_copy_from)` AND `some(p => p.can_copy_to)` for Copiar tab
- `activeView` pattern: fallback to first visible tab if current view is hidden
- UsersPage inline panels are mutually exclusive: opening permissions closes edit (and vice versa) via state resets
- Permissions API: GET returns `[{seller_slug, seller_name, can_copy_from, can_copy_to}]`, PUT accepts `{permissions: [...]}`

---

## 2026-02-27 - US-001
- Already committed in previous iteration (commit 44b8ee0)
- Migration file: app/db/migrations/004_user_auth.sql (numbered 004 not 003)
- Tables: users, user_sessions, user_permissions, auth_logs
- ALTER TABLE copy_logs and compat_logs to add user_id column
- **Learnings for future iterations:**
  - Migration numbering gap (no 003) — 004 is fine, just note in docs
  - All tables use UUID PKs with gen_random_uuid()

---

## 2026-02-27 - US-002
- Rewrote app/routers/auth.py: replaced admin_config-based auth with users/user_sessions tables
- Added ADMIN_MASTER_PASSWORD to app/config.py Settings class
- Files changed: app/routers/auth.py, app/config.py
- **Learnings for future iterations:**
  - `require_admin()` is a drop-in replacement — takes same Header param, now returns user dict instead of True
  - `require_user()` returns dict: {id, username, role, can_run_compat, permissions: [{seller_slug, can_copy_from, can_copy_to}]}
  - auth_ml.py imports require_admin — any signature change must be backward compatible
  - copy.py and compat.py use require_admin as router-level dependency (will change to require_user in US-006)

---

## 2026-02-27 - US-003
- Added POST /api/auth/admin-promote endpoint to app/routers/auth.py
- Endpoint accepts {username, password, master_password}
- Creates new admin user or promotes existing user to admin
- Logs action='admin_promote' to auth_logs table
- Files changed: app/routers/auth.py
- **Learnings for future iterations:**
  - admin_master_password in config defaults to "" (empty string) — check with `not settings.admin_master_password`
  - admin-promote endpoint is unauthenticated (no Depends) — it's the bootstrap mechanism
  - Reuse `_hash_password()` helper already in auth.py for all password hashing

---

## 2026-02-27 - US-004
- Created app/routers/admin_users.py with CRUD endpoints for user management
- Registered router in app/main.py with prefix /api/admin
- Endpoints: GET /api/admin/users, POST /api/admin/users, PUT /api/admin/users/{user_id}, DELETE /api/admin/users/{user_id}
- All endpoints protected by require_admin dependency
- Files changed: app/routers/admin_users.py (new), app/main.py
- **Learnings for future iterations:**
  - admin_users.py has its own `_hash_password()` (duplicated from auth.py) to keep the module self-contained
  - USER_FIELDS constant excludes password_hash — use it for all user queries returned to clients
  - Delete endpoint prevents self-deletion by comparing user_id param to authenticated user's id
  - 409 status for duplicate username on create

---

## 2026-02-27 - US-005
- Added GET /api/admin/users/{user_id}/permissions endpoint to admin_users.py
- Added PUT /api/admin/users/{user_id}/permissions endpoint to admin_users.py
- GET merges all sellers from copy_sellers with existing user_permissions, defaulting to false/false
- PUT uses Supabase .upsert() with on_conflict="user_id,seller_slug" for each entry
- Added Pydantic models: PermissionEntry, UpdatePermissionsRequest
- Files changed: app/routers/admin_users.py
- **Learnings for future iterations:**
  - copy_sellers table has `slug` and `name` columns for seller identification
  - Supabase upsert: `.upsert(data, on_conflict="col1,col2")` for composite unique constraints
  - Permissions GET returns `seller_name` from copy_sellers for display, not stored in user_permissions
  - PUT accepts `{permissions: [{seller_slug, can_copy_from, can_copy_to}]}` as request body

---

## 2026-02-27 - US-006
- Replaced `require_admin` with `require_user` in copy.py and compat.py (per-endpoint, not router-level)
- Added `_check_seller_permission(user, seller_slug, direction)` helper in copy.py for source/dest checks
- POST /api/copy and POST /api/copy/with-dimensions: check can_copy_from for source, can_copy_to for each dest. Return 403 with specific seller names on denial
- GET /api/copy/preview: require_user only (any authenticated user can preview)
- GET /api/copy/logs and GET /api/compat/logs: require_user only
- POST /api/compat/copy and GET /api/compat/preview: check user.can_run_compat, return 403 if not permitted
- POST /api/compat/search-sku: filter sellers to can_copy_to via allowed_sellers param in search_sku_all_sellers
- Modified search_sku_all_sellers in compat_copier.py to accept optional allowed_sellers parameter
- auth_ml.py unchanged (keeps require_admin for seller management)
- Files changed: app/routers/copy.py, app/routers/compat.py, app/services/compat_copier.py
- **Learnings for future iterations:**
  - Router-level `dependencies=[Depends(require_admin)]` was removed; each endpoint now has explicit `user: dict = Depends(require_user)` for granular control
  - Admin bypass pattern: check `user["role"] == "admin"` before any permission check
  - For seller permission checks, iterate `user["permissions"]` list matching seller_slug
  - The `allowed_sellers=None` pattern means "all sellers" (admin), while a list filters (operator)

---

## 2026-02-27 - US-007
- Added user_id to copy_logs insertion in item_copier.py (copy_items accepts user_id param)
- Added user_id to compat_logs insertion in compat_copier.py (copy_compat_to_targets accepts user_id param)
- Passed user["id"] from copy.py and compat.py routers to service functions
- Added auth_logs entries in auth.py: login success (action='login'), login failure (action='login_failed'), logout (action='logout')
- Updated GET /api/copy/logs: operators see only their logs (filter by user_id), admins see all. Includes username via Supabase join
- Updated GET /api/compat/logs: same operator/admin filtering with username join
- Files changed: app/routers/auth.py, app/routers/copy.py, app/routers/compat.py, app/services/item_copier.py, app/services/compat_copier.py
- **Learnings for future iterations:**
  - Supabase FK join syntax: `.select("*, users(username)")` returns `{"users": {"username": "..."}}` — flatten before returning
  - Wrap audit log inserts in try/except to avoid breaking main operations on logging failure
  - For compat background tasks (`bg.add_task`), pass user_id as positional arg after skus
  - Login failure logging captures username even when user doesn't exist (user_id will be null)

---

## 2026-02-27 - US-008
- Updated Login.tsx: replaced single password field with username + password fields
- Added "Acesso Admin" discrete link that toggles a master password field for admin-promote flow
- Admin-promote calls POST /api/auth/admin-promote then auto-logs in via onLogin
- Normal login calls onLogin(username, password) which sends {username, password} to POST /api/auth/login
- Updated useAuth.ts: TOKEN_KEY from 'copy-admin-token' to 'copy-auth-token', header from X-Admin-Token to X-Auth-Token, login accepts (username, password) instead of just (password)
- Old single-password login flow completely removed
- Files changed: frontend/src/pages/Login.tsx, frontend/src/hooks/useAuth.ts
- **Learnings for future iterations:**
  - Login.tsx imports API_BASE from lib/api for the admin-promote call (only Login does this, other API calls go through useAuth)
  - The onLogin prop signature changed from `(password) => boolean` to `(username, password) => boolean` — any component passing auth.login is automatically compatible
  - Admin-promote flow: call /api/auth/admin-promote first, then call onLogin to get a session token (two-step)
  - inputStyle helper function extracted for consistent border-color on error state across all input fields

---

## 2026-02-27 - US-009
- Updated useAuth.ts: added fetchMe() to call GET /api/auth/me on mount and store full user object
- Added AuthUser and UserPermission TypeScript interfaces exported from useAuth.ts
- isAuthenticated now requires both token AND user object
- On mount with existing token, fetches /api/auth/me; on 401, clears auth state
- Updated App.tsx: username displayed in navbar, tabs conditionally rendered based on user permissions
- Copiar tab: shown if admin OR has >=1 can_copy_from AND >=1 can_copy_to permissions
- Compat tab: shown if admin OR can_run_compat is true
- Sellers (Admin) tab: shown only if user.role === 'admin'
- activeView falls back to first visible tab if current view is not available
- Files changed: frontend/src/hooks/useAuth.ts, frontend/src/App.tsx
- **Learnings for future iterations:**
  - useAuth.fetchMe is called with explicit token param (not from state) to avoid stale closure issues
  - On login, fetchMe is called immediately after setting token to populate user before sellers load
  - The visibleTabs useMemo pattern allows clean conditional tab rendering without nested ternaries
  - `activeView` computed variable auto-redirects if user's current tab becomes hidden

---

## 2026-02-27 - US-010
- Created frontend/src/pages/UsersPage.tsx with full user management UI
- Table displays: username, role badge (Admin/Operador), compat tag, active/inactive status, last login date
- "Novo Usuário" button opens inline create form with: username, password, role (select), can_run_compat (checkbox)
- Each row has "Editar" button that expands inline edit form below the row: password (optional), role, can_run_compat, active toggle
- Each row has "Deletar" button with confirm() dialog; button hidden for current user (self-deletion prevented)
- All API calls use X-Auth-Token header via headers() prop and show toast on success/error
- Updated App.tsx: main navbar tab renamed from "Sellers" to "Admin", added sub-navigation with ViewTab for "Sellers" vs "Usuários" inside admin section
- Added `adminSubView` state to App.tsx for toggling between sellers and users management
- UsersPage imported and rendered in App.tsx with headers and currentUserId props
- Files changed: frontend/src/pages/UsersPage.tsx (new), frontend/src/App.tsx
- **Learnings for future iterations:**
  - Admin sub-navigation reuses the same ViewTab component from App.tsx (no duplication needed)
  - UsersPage takes `currentUserId` prop to disable self-delete (simpler than importing useAuth)
  - RoleBadge and Tag are local helper components inside UsersPage — not exported
  - Inline edit form appears directly below the user row (borderTop: none, borderRadius bottom only) for visual continuity
  - `color-mix(in srgb, color 10%, transparent)` works well for badge backgrounds across themes

---

## 2026-02-27 - US-011
- Added permissions panel to UsersPage.tsx with expand/collapse per user row
- "Permissões" button added to each user row's action buttons
- Panel fetches GET /api/admin/users/{id}/permissions on open, displays sellers with Origem/Destino checkboxes
- Save button calls PUT /api/admin/users/{id}/permissions with full array
- Admin users see "Admins têm acesso total a todos os sellers" message instead of checkboxes
- Empty state shows "Nenhum seller conectado" when no sellers are available
- Permissions panel and edit form are mutually exclusive (opening one closes the other)
- Files changed: frontend/src/pages/UsersPage.tsx
- **Learnings for future iterations:**
  - The `permissionsId` state pattern mirrors `editingId` — both expand inline panels below a user row
  - Opening permissions panel closes edit form and create form (and vice versa) for clean UX
  - Permission checkboxes track state locally via `permissions` useState array, then send full array on save
  - The `PermissionRow` interface includes `seller_name` for display (comes from backend merge with copy_sellers)
  - `var(--surface)` background on individual permission rows provides visual separation from the panel background

---
