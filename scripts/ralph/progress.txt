# Ralph Progress Log
Started: Fri Feb 27 11:00:28 -03 2026
---

## Codebase Patterns
- Supabase client: use `get_db()` from `app/db/supabase.py`, returns a `Client` instance
- Supabase insert returns: `row = db.table("x").insert({...}).execute()` → `row.data[0]["id"]` for the new row id
- Supabase update pattern: `db.table("x").update({...}).eq("id", row_id).execute()`
- copy_logs table has no CHECK constraint on status — any string value is accepted
- No pyproject.toml — use `mypy --ignore-missing-imports` and `ruff check` for quality checks
- Migrations live in `app/db/migrations/` using plain SQL files with numeric prefixes
- compat_logs table originally had no `status` column — added via migration 003
- Use `python3` not `python` for CLI tools (mypy, ruff) on this machine

## 2026-02-27 - US-001
- Implemented in_progress status for copy_logs in `copy_items()` function
- Modified `app/services/item_copier.py`: insert in_progress row before copy loop, update with final status after
- Added fallback: if in_progress insert fails, falls back to inserting a new row with final status
- Files changed: `app/services/item_copier.py`
- **Learnings for future iterations:**
  - The `copy_items` function handles multiple items × multiple destinations. The log is per-item (one log row per source item), not per item×destination pair
  - `copy_single_item` returns a result dict with status/dest_item_id/error — the aggregation happens in `copy_items`
  - Supabase insert `.execute()` returns `.data` as a list; get the id with `.data[0]["id"]`
  - No CHECK constraint on status column — `in_progress` works without migration
---

## 2026-02-27 - US-002
- Implemented in_progress status for compat_logs in compat copy flow
- Added migration `app/db/migrations/003_compat_logs_status.sql` to add `status` column to compat_logs
- Modified `app/routers/compat.py`: create in_progress log row before background task, pass log_id
- Modified `app/services/compat_copier.py`: accept optional `log_id` param, update existing row instead of inserting new one
- Final status is determined: success (all ok), error (all failed), partial (mixed)
- Files changed: `app/routers/compat.py`, `app/services/compat_copier.py`, `app/db/migrations/003_compat_logs_status.sql`
- **Learnings for future iterations:**
  - compat_logs originally had no `status` column — had to add via ALTER TABLE migration
  - The `copy_compat` endpoint creates the log row synchronously, then the background task updates it
  - `log_id` is passed as a keyword arg to the background task — FastAPI BackgroundTasks supports this
  - Kept legacy insert path in `copy_compat_to_targets` when `log_id` is None for backward compatibility
---
