# Ralph Progress Log
Started: Fri Feb 27 11:00:28 -03 2026
---

## Codebase Patterns
- Supabase client: use `get_db()` from `app/db/supabase.py`, returns a `Client` instance
- Supabase insert returns: `row = db.table("x").insert({...}).execute()` → `row.data[0]["id"]` for the new row id
- Supabase update pattern: `db.table("x").update({...}).eq("id", row_id).execute()`
- copy_logs table has no CHECK constraint on status — any string value is accepted
- No pyproject.toml — use `mypy --ignore-missing-imports` and `ruff check` for quality checks
- Migrations live in `app/db/migrations/` using plain SQL files with numeric prefixes
- compat_logs table originally had no `status` column — added via migration 003
- Use `python3` not `python` for CLI tools (mypy, ruff) on this machine
- ML item SKU locations: `item.seller_custom_field`, `item.variations[].seller_custom_field`, `item.variations[].attributes[{id:"SELLER_SKU"}].value_name`
- StatusBadge in CopyPage.tsx uses `c` (color) and `bg` (background) maps keyed by status string — add new statuses to both
- Pulse animations (`pulse-badge`, `pulse-dot`) are defined in `index.css` — reuse for any in_progress indicator
- In React hooks, define `useCallback` dependencies before consumers — no hoisting like regular functions

## 2026-02-27 - US-001
- Implemented in_progress status for copy_logs in `copy_items()` function
- Modified `app/services/item_copier.py`: insert in_progress row before copy loop, update with final status after
- Added fallback: if in_progress insert fails, falls back to inserting a new row with final status
- Files changed: `app/services/item_copier.py`
- **Learnings for future iterations:**
  - The `copy_items` function handles multiple items × multiple destinations. The log is per-item (one log row per source item), not per item×destination pair
  - `copy_single_item` returns a result dict with status/dest_item_id/error — the aggregation happens in `copy_items`
  - Supabase insert `.execute()` returns `.data` as a list; get the id with `.data[0]["id"]`
  - No CHECK constraint on status column — `in_progress` works without migration
---

## 2026-02-27 - US-002
- Implemented in_progress status for compat_logs in compat copy flow
- Added migration `app/db/migrations/003_compat_logs_status.sql` to add `status` column to compat_logs
- Modified `app/routers/compat.py`: create in_progress log row before background task, pass log_id
- Modified `app/services/compat_copier.py`: accept optional `log_id` param, update existing row instead of inserting new one
- Final status is determined: success (all ok), error (all failed), partial (mixed)
- Files changed: `app/routers/compat.py`, `app/services/compat_copier.py`, `app/db/migrations/003_compat_logs_status.sql`
- **Learnings for future iterations:**
  - compat_logs originally had no `status` column — had to add via ALTER TABLE migration
  - The `copy_compat` endpoint creates the log row synchronously, then the background task updates it
  - `log_id` is passed as a keyword arg to the background task — FastAPI BackgroundTasks supports this
  - Kept legacy insert path in `copy_compat_to_targets` when `log_id` is None for backward compatibility
---

## 2026-02-27 - US-003
- Added SKU extraction to `GET /api/compat/preview/{item_id}` endpoint
- Extracts SKUs from: item-level `seller_custom_field`, variation-level `seller_custom_field`, and variation attributes where `id='SELLER_SKU'`
- Returns deduplicated `skus` array (preserves order) in the response alongside existing fields
- Returns empty array if no SKUs found
- Files changed: `app/routers/compat.py`
- **Learnings for future iterations:**
  - ML API item structure: `item.seller_custom_field` for item-level SKU, `item.variations[].seller_custom_field` for variation SKU, `item.variations[].attributes` array with `{id: "SELLER_SKU", value_name: "..."}` for attribute-based SKU
  - `get_item()` already returns full item data including variations — no extra API call needed
  - Order-preserving deduplication: use a `seen` set + list instead of `list(set(...))` which loses order
---

## 2026-02-27 - US-004
- Added in_progress status polling to CopyPage history table
- StatusBadge now shows pulsing blue "Copiando..." badge with animated dot for in_progress rows
- Added useEffect + useRef polling: setInterval every 5s while any row has status 'in_progress', auto-stops when none remain
- Moved loadLogs() above handleCopy to fix TS block-scoped variable ordering
- Added setTimeout(loadLogs, 1000) after copy submission to pick up in_progress rows mid-operation
- Moved final loadLogs() call to `finally` block so it runs on both success and error
- Added pulse-badge and pulse-dot keyframes to index.css
- Files changed: `frontend/src/pages/CopyPage.tsx`, `frontend/src/index.css`
- **Learnings for future iterations:**
  - useCallback ordering matters in React — a callback referencing another must be defined after it (no hoisting like regular functions)
  - StatusBadge component in CopyPage.tsx is shared for rendering all status types — add new statuses to both `c` and `bg` maps
  - The copy POST is synchronous (awaited), so to show in_progress rows you need a setTimeout to refresh logs while the POST is pending
  - CSS keyframes for pulse animations are in index.css: `pulse-badge` and `pulse-dot` — reuse these in CompatPage (US-005)
---

## 2026-02-27 - US-005
- Added in_progress status polling to CompatPage history table
- Added `status` field to CompatLog interface (optional for backward compat with legacy rows)
- Created CompatStatusBadge component: derives status from explicit field or falls back to success/error/partial counts for legacy rows
- Added useRef + useEffect polling: setInterval every 5s while any row has status 'in_progress', auto-stops when none remain
- Replaced setTimeout-based refresh (5s/15s/30s) with immediate loadLogs() in finally + setTimeout(loadLogs, 1000) for picking up in_progress rows
- Added 'Status' column to history table with pulsing blue "Copiando..." badge for in_progress rows
- Reused pulse-badge and pulse-dot CSS animations from index.css (added in US-004)
- Files changed: `frontend/src/pages/CompatPage.tsx`
- **Learnings for future iterations:**
  - CompatStatusBadge needs fallback logic for legacy compat_logs rows that don't have a `status` column — derive from success_count/error_count
  - The compat copy endpoint returns synchronously (background task), so `loadLogs()` in `finally` picks up the in_progress row immediately
  - Same polling pattern as CopyPage: useRef for interval, hasInProgress derived from logs, useEffect cleanup
---

## 2026-02-27 - US-006
- Added `skus: string[]` to `CompatPreview` interface in `api.ts`
- Added SKU chip display in CompatPage preview card with copy-to-clipboard buttons
- Each SKU renders as a clickable chip with a copy icon (⧉); clicking copies to clipboard via `navigator.clipboard.writeText()`
- After copying, shows a checkmark (✓) in green for 2 seconds as visual feedback
- If no SKUs found, shows "Sem SKU" in muted text
- Used `copiedSku` state with `setTimeout` to reset feedback after 2s
- Files changed: `frontend/src/lib/api.ts`, `frontend/src/pages/CompatPage.tsx`
- **Learnings for future iterations:**
  - The `CompatPreview` type in `api.ts` must match backend response fields — `skus` was added in US-003 backend but type wasn't updated until now
  - `navigator.clipboard.writeText()` works in modern browsers without fallback; returns a Promise but fire-and-forget is fine for UX
  - Using a single `copiedSku` state string works well for tracking which chip shows feedback — no need for a map/object when only one can be copied at a time
---

## 2026-02-27 - US-007
- Replaced `<SellerSelect>` dropdown for origin seller with checkbox-style buttons matching destination layout
- Single-select behavior: clicking a seller selects it, clicking again deselects; when one is selected, others are visually disabled
- Disabled sellers have `opacity: 0.4`, `cursor: not-allowed`, and muted color
- Selected seller shows checkmark (✓) and ink/paper inverted style, same as destination chips
- Removed `SellerSelect` import (no longer used in CopyForm)
- Existing behavior preserved: selected origin seller is excluded from destination checkboxes
- Files changed: `frontend/src/components/CopyForm.tsx`
- **Learnings for future iterations:**
  - The `chip-toggle` CSS class and the destination button styling pattern are the canonical way to render seller selectors — reuse for any new seller selection UI
  - For single-select with visual disable: use `opacity: 0.4` + `cursor: not-allowed` + early return in onClick for disabled items
  - `SellerSelect` component still exists in `frontend/src/components/SellerSelect.tsx` but is now unused — can be deleted in a future cleanup
---
