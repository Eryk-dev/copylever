# Ralph Progress Log
Started: Fri Feb 27 11:46:39 -03 2026

## Codebase Patterns
- Use `bcrypt.hashpw(password.encode("utf-8"), bcrypt.gensalt()).decode("utf-8")` for password hashing
- Use `bcrypt.checkpw(password.encode(), hashed.encode())` for password verification
- Supabase client: `db.table("name").select/insert/update/delete` pattern via `get_db()` from `app.db.supabase`
- FastAPI dependencies that return user dicts are passed via `Depends()` — use `user: dict = Depends(require_user)`
- Auth header is `X-Auth-Token` extracted via `Header(...)` in FastAPI
- Session tokens are `secrets.token_urlsafe(32)` with 7-day expiry stored in `user_sessions`
- All migrations use `IF NOT EXISTS` pattern
- Python modules compile-checked with `python3 -m py_compile`
- Frontend typecheck: `cd frontend && npx tsc --noEmit`
- `require_admin` from `app.routers.auth` is imported by `auth_ml.py`, `copy.py`, `compat.py`, `admin_users.py`
- Admin user CRUD router: `app/routers/admin_users.py` with prefix `/api/admin`
- USER_FIELDS constant for safe select (excludes password_hash): `"id, username, role, can_run_compat, active, created_at, last_login_at"`
- Supabase upsert with composite key: `.upsert(data, on_conflict="col1,col2")`
- `copy_sellers` table has `slug` and `name` columns for seller identification

---

## 2026-02-27 - US-001
- Already committed in previous iteration (commit 44b8ee0)
- Migration file: app/db/migrations/004_user_auth.sql (numbered 004 not 003)
- Tables: users, user_sessions, user_permissions, auth_logs
- ALTER TABLE copy_logs and compat_logs to add user_id column
- **Learnings for future iterations:**
  - Migration numbering gap (no 003) — 004 is fine, just note in docs
  - All tables use UUID PKs with gen_random_uuid()

---

## 2026-02-27 - US-002
- Rewrote app/routers/auth.py: replaced admin_config-based auth with users/user_sessions tables
- Added ADMIN_MASTER_PASSWORD to app/config.py Settings class
- Files changed: app/routers/auth.py, app/config.py
- **Learnings for future iterations:**
  - `require_admin()` is a drop-in replacement — takes same Header param, now returns user dict instead of True
  - `require_user()` returns dict: {id, username, role, can_run_compat, permissions: [{seller_slug, can_copy_from, can_copy_to}]}
  - auth_ml.py imports require_admin — any signature change must be backward compatible
  - copy.py and compat.py use require_admin as router-level dependency (will change to require_user in US-006)

---

## 2026-02-27 - US-003
- Added POST /api/auth/admin-promote endpoint to app/routers/auth.py
- Endpoint accepts {username, password, master_password}
- Creates new admin user or promotes existing user to admin
- Logs action='admin_promote' to auth_logs table
- Files changed: app/routers/auth.py
- **Learnings for future iterations:**
  - admin_master_password in config defaults to "" (empty string) — check with `not settings.admin_master_password`
  - admin-promote endpoint is unauthenticated (no Depends) — it's the bootstrap mechanism
  - Reuse `_hash_password()` helper already in auth.py for all password hashing

---

## 2026-02-27 - US-004
- Created app/routers/admin_users.py with CRUD endpoints for user management
- Registered router in app/main.py with prefix /api/admin
- Endpoints: GET /api/admin/users, POST /api/admin/users, PUT /api/admin/users/{user_id}, DELETE /api/admin/users/{user_id}
- All endpoints protected by require_admin dependency
- Files changed: app/routers/admin_users.py (new), app/main.py
- **Learnings for future iterations:**
  - admin_users.py has its own `_hash_password()` (duplicated from auth.py) to keep the module self-contained
  - USER_FIELDS constant excludes password_hash — use it for all user queries returned to clients
  - Delete endpoint prevents self-deletion by comparing user_id param to authenticated user's id
  - 409 status for duplicate username on create

---

## 2026-02-27 - US-005
- Added GET /api/admin/users/{user_id}/permissions endpoint to admin_users.py
- Added PUT /api/admin/users/{user_id}/permissions endpoint to admin_users.py
- GET merges all sellers from copy_sellers with existing user_permissions, defaulting to false/false
- PUT uses Supabase .upsert() with on_conflict="user_id,seller_slug" for each entry
- Added Pydantic models: PermissionEntry, UpdatePermissionsRequest
- Files changed: app/routers/admin_users.py
- **Learnings for future iterations:**
  - copy_sellers table has `slug` and `name` columns for seller identification
  - Supabase upsert: `.upsert(data, on_conflict="col1,col2")` for composite unique constraints
  - Permissions GET returns `seller_name` from copy_sellers for display, not stored in user_permissions
  - PUT accepts `{permissions: [{seller_slug, can_copy_from, can_copy_to}]}` as request body

---
