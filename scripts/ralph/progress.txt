# Ralph Progress Log
Started: Fri Feb 27 11:46:39 -03 2026

## Codebase Patterns
- Use `bcrypt.hashpw(password.encode("utf-8"), bcrypt.gensalt()).decode("utf-8")` for password hashing
- Use `bcrypt.checkpw(password.encode(), hashed.encode())` for password verification
- Supabase client: `db.table("name").select/insert/update/delete` pattern via `get_db()` from `app.db.supabase`
- FastAPI dependencies that return user dicts are passed via `Depends()` — use `user: dict = Depends(require_user)`
- Auth header is `X-Auth-Token` extracted via `Header(...)` in FastAPI
- Session tokens are `secrets.token_urlsafe(32)` with 7-day expiry stored in `user_sessions`
- All migrations use `IF NOT EXISTS` pattern
- Python modules compile-checked with `python3 -m py_compile`
- Frontend typecheck: `cd frontend && npx tsc --noEmit`
- `require_admin` from `app.routers.auth` is imported by `auth_ml.py`, `copy.py`, `compat.py`

---

## 2026-02-27 - US-001
- Already committed in previous iteration (commit 44b8ee0)
- Migration file: app/db/migrations/004_user_auth.sql (numbered 004 not 003)
- Tables: users, user_sessions, user_permissions, auth_logs
- ALTER TABLE copy_logs and compat_logs to add user_id column
- **Learnings for future iterations:**
  - Migration numbering gap (no 003) — 004 is fine, just note in docs
  - All tables use UUID PKs with gen_random_uuid()

---

## 2026-02-27 - US-002
- Rewrote app/routers/auth.py: replaced admin_config-based auth with users/user_sessions tables
- Added ADMIN_MASTER_PASSWORD to app/config.py Settings class
- Files changed: app/routers/auth.py, app/config.py
- **Learnings for future iterations:**
  - `require_admin()` is a drop-in replacement — takes same Header param, now returns user dict instead of True
  - `require_user()` returns dict: {id, username, role, can_run_compat, permissions: [{seller_slug, can_copy_from, can_copy_to}]}
  - auth_ml.py imports require_admin — any signature change must be backward compatible
  - copy.py and compat.py use require_admin as router-level dependency (will change to require_user in US-006)

---
