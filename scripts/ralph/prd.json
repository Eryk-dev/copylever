{
  "project": "COPY ANUNCIOS — Refactor Compat Backend",
  "branchName": "ralph/refactor-compat-backend",
  "description": "Fix compatibility copy endpoints to follow MercadoLivre official documentation: use POST/PUT correctly based on existing compats, replace User Product batch with /copy-paste endpoint, add add/replace mode toggle.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Refactor copy_item_compatibilities: POST vs PUT and mode parameter",
      "description": "As the system, I want copy_item_compatibilities() to correctly choose between POST (no existing compats) and PUT (has existing compats), and support a mode parameter for add vs replace behavior.",
      "acceptanceCriteria": [
        "Function copy_item_compatibilities in app/services/ml_api.py accepts new parameter mode: str = 'add'",
        "Before copying, function calls GET /items/{dest_id}/compatibilities (using existing get_item_compatibilities with the dest seller_slug) to check if destination has existing compatibilities",
        "When mode='add' and destination has NO compatibilities: uses POST /items/{id}/compatibilities with body {\"item_to_copy\": {\"item_id\": source_id, \"extended_information\": true}} (existing behavior)",
        "When mode='add' and destination HAS compatibilities: uses PUT /items/{id}/compatibilities with body {\"create\": {\"item_to_copy\": {\"item_id\": source_id, \"extended_information\": true}}}",
        "When mode='replace' and destination HAS compatibilities: extracts product IDs from GET response, then uses PUT /items/{id}/compatibilities with body {\"delete\": {\"product_ids\": [...]}, \"create\": {\"item_to_copy\": {\"item_id\": source_id, \"extended_information\": true}}}",
        "When mode='replace' and destination has NO compatibilities: uses POST (same as add, nothing to delete)",
        "Existing User Product fallback (_is_user_product_error check) is kept for now — do NOT remove it in this story",
        "Uses _post_with_retry for POST calls and a new _put_with_retry (or generalized _request_with_retry) for PUT calls",
        "Logs which HTTP method was used (POST or PUT) at info level",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "File: app/services/ml_api.py, function starts at line 363. Current signature: async def copy_item_compatibilities(seller_slug, new_item_id, source_item_id, source_compat_products=None). Add mode param but keep source_compat_products for backward compatibility (item_copier.py still passes it). The seller_slug param is the DESTINATION seller. Use get_item_compatibilities(seller_slug, new_item_id) to check dest compats — it returns None if 404 (no compats) or a dict with 'products' list. For replace mode, extract product IDs: [p['catalog_product_id'] for p in compat.get('products', []) if p.get('catalog_product_id')]. The _post_with_retry helper already exists at line 336 — create a similar _put_with_retry or generalize to _request_with_retry(method, ...). ML_API constant and _get_token() are already available in the file."
    },
    {
      "id": "US-002",
      "title": "Replace User Product flow with /copy-paste endpoint",
      "description": "As the system, I want to pre-detect User Product items and use the correct /copy-paste endpoint instead of the legacy batch approach.",
      "acceptanceCriteria": [
        "In copy_item_compatibilities, before choosing the copy method, fetch dest item info via GET /items/{new_item_id} to check for user_product_id field",
        "If dest item has user_product_id: route to new _copy_user_product_copy_paste() function instead of trying item endpoint first",
        "New function _copy_user_product_copy_paste() calls POST /user-products/{user_product_id}/compatibilities/copy-paste",
        "Request body includes domain_id (from new source_domain_id param), category_id (from dest item's category_id field), item_id (the source_item_id), and extended_information: true",
        "Function accepts source_domain_id as optional parameter — if not provided, fetches source compats to extract domain_id from products[0]['domain_id']",
        "Never sends both item_id and user_product_id in the request body (only item_id as source reference)",
        "Delete legacy function _copy_user_product_compatibilities() (line 396-458)",
        "Delete legacy function _is_user_product_error() (line 351-360)",
        "Remove the _is_user_product_error fallback check from copy_item_compatibilities",
        "Uses retry logic for 429 rate limiting on the /copy-paste POST",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "File: app/services/ml_api.py. The dest item GET to check user_product_id can reuse get_item(seller_slug, new_item_id) which already exists. The dest item response also has category_id field — save it for the /copy-paste body. For source_domain_id: add as optional param to copy_item_compatibilities(). If None and User Product detected, call get_item_compatibilities() on source to extract domain_id (fallback). In US-003, compat_copier will pre-fetch and pass this. The /copy-paste endpoint URL: f'{ML_API}/user-products/{user_product_id}/compatibilities/copy-paste'. Keep the source_compat_products param in the signature for backward compat with item_copier.py but it won't be used internally anymore."
    },
    {
      "id": "US-003",
      "title": "Wire mode and source_domain_id through compat_copier and router",
      "description": "As the system, I want the mode parameter and source_domain_id to flow from the API endpoint through compat_copier to copy_item_compatibilities.",
      "acceptanceCriteria": [
        "CopyRequest model in app/routers/compat.py has new field mode: str = 'add' with validation that value is 'add' or 'replace'",
        "POST /api/compat/copy endpoint passes req.mode to copy_compat_to_targets()",
        "copy_compat_to_targets() in app/services/compat_copier.py accepts mode parameter and passes it to copy_item_compatibilities()",
        "In copy_compat_to_targets(), extract source_domain_id from the pre-fetched source compats: source_compat_products[0]['domain_id'] if available",
        "Pass source_domain_id to each copy_item_compatibilities() call",
        "The in_progress log row includes the mode used",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Files: app/routers/compat.py (CopyRequest at line 110, copy_compat endpoint at line 116) and app/services/compat_copier.py (copy_compat_to_targets at line 86). The compat_copier already pre-fetches source compats at line 99-108: compat = await get_item_compatibilities(source_seller, source_item_id) then source_compat_products = compat.get('products'). Extract domain_id: source_domain_id = source_compat_products[0]['domain_id'] if source_compat_products else None. Pass both mode and source_domain_id to copy_item_compatibilities(). For validation, use Literal['add', 'replace'] from typing or a simple check."
    },
    {
      "id": "US-004",
      "title": "Frontend: add/replace toggle in CompatPage",
      "description": "As an operator, I want a toggle to choose between adding compatibilities to existing ones or replacing them completely.",
      "acceptanceCriteria": [
        "CompatPage.tsx shows a select or toggle with options 'Adicionar às existentes' (value: 'add', default) and 'Substituir todas' (value: 'replace')",
        "The toggle is visible in step 3 (before the copy button), between the target items list and the action button",
        "Selected mode is sent as 'mode' field in the POST /api/compat/copy request body",
        "Toggle follows existing design patterns (CSS variables, styling consistent with other form elements on the page)",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "File: frontend/src/pages/CompatPage.tsx. The copy action is triggered around the step 3 section. Look for the fetch call to '/api/compat/copy' and add mode to the body. For the UI element, use a <select> with two <option>s or two radio buttons. Use the same styling as other inputs on the page. Add useState<'add' | 'replace'>('add') for state management. The copyCompat function (or similar) sends the POST — add mode to the JSON body alongside source_item_id, targets, and skus."
    }
  ]
}
